---
title: "Affordability of Residential Real Estate in Warsaw"
output:
    rmarkdown::html_document:
        toc: true
        toc_float: true
        toc_depth: 3
        number_sections: true
        code_folding: hide
---

<center>

---

**R-Bootcamp Project – W.MSCIDS_RB01.H2501**

Alena Ploshchansky · Rita Ahlborn

*Master of Science in Real Estate*

*Minor in Data Science*

Lucerne University of Applied Sciences and Arts

January 28, 2026



</center>

```{css, echo=FALSE}
p {
  text-align: justify;}
center p {
  text-align: center;}
h1.title {
  text-align: center;}
p.author,
p.date {
  text-align: center;}
```

---

![*Warsaw Skyline*](fototapeta-panoramiczna-warszawa-z-lotu-ptaka-5.jpg "Source: Lunares.pl"){width=100%}

---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = ".")
```

```{r libraries, include = FALSE}
# Load required libraries
# Here maybe we should separate libtraries based on usage
library(dplyr)
library(ggplot2)
library(tidyr)
library(readxl)
library(janitor)
library(stringi)
library(stringr)
library(tidygeocoder)
library(writexl)
library(readr)

# Libraries for R markdown
library(knitr)
library(kableExtra)
library(rmarkdown)

# Libraries for visualizations
library(RColorBrewer)
library(scales)
library(ggridges)
library(viridis)

# Libraries for maps
library(ggmap)
library(sf)
library(rlang)
library(leaflet)
library(osmdata)

# Libraries for statistical analysis
library(broom)
library(tibble)
# To be updated ...
```

```{r data, include = FALSE}
# Loading the datasets
# Prices data set
prices <- read_excel("Prices.xlsx")

# Density data set
density <- read_excel("Density.xlsx", sheet="TABLE")

# Median wage data set
median_wage <- read_excel("MedianWage.xlsx", sheet="TABLE")
```

```{r prices_values, include = FALSE}
# Check for missing values
sum(is.na(prices))

# Remove and change polish letters, convert to lower case
clean_prices <- prices %>%
  clean_names() %>%
  mutate(across(where(is.character),
                ~ tolower(stri_trans_general(., "Latin-ASCII"))))

# Remove unnecessary columns
clean_prices <- clean_prices %>%
  select(-c("zrodlo_informacji", "cena_wartosc", "waluta", "numer_budynku"))
```

```{r prices_geo, include = FALSE}
# Here we create new variables: price per sqm, log price per sqm, etc.
# Coordinates data type conversion and save
if (!file.exists("streets_geo.rds")) {

  streets_geo <- clean_prices %>%
    distinct(ulica) %>%
    mutate(address = paste0(ulica, ", Warsaw, Poland")) %>%
    geocode(
      address = address,
      method = "osm",
      lat = latitude,
      long = longitude)

  saveRDS(streets_geo, "streets_geo.rds")}

# Load saved geo data
streets_geo <- readRDS("streets_geo.rds")

clean_prices <- clean_prices %>%
  left_join(streets_geo, by = "ulica")
```

```{r prices_cleaning, include = FALSE}
# Remove unnecessary columns
clean_prices <- clean_prices %>%
  select(-address)

# Delete rows with missing coordinates
clean_prices <- clean_prices %>%
  filter(!is.na(latitude) & !is.na(longitude))
```

```{r prices_age, include = FALSE}
# Create building age groups
clean_prices <- clean_prices %>%
  mutate(
    building_age_group = case_when(
      rok_budowy < 1960 ~ "very_old",
      rok_budowy >= 1960 & rok_budowy < 2010 ~ "old",
      rok_budowy >= 2010 & rok_budowy <= 2025 ~ "new",
      TRUE ~ NA_character_))
```

```{r prices_date, include = FALSE}
# Date conversion
clean_prices <- clean_prices %>%
  mutate(quarter_only = str_extract(data_transakcji_wyceny, "q[1-4]")) %>% # we left quarter only as all the data is from 2025
  select(-data_transakcji_wyceny)
```

```{r prices_log_sqm, include = FALSE}
# Add log price per sqm
clean_prices <- clean_prices %>%
  relocate(quarter_only, .before = cena_wartosc_1m2) %>%
  mutate(log_price_sqm = log(cena_wartosc_1m2)) %>%
  relocate(log_price_sqm, .after = cena_wartosc_1m2)
```

```{r wage_cleaning, include = FALSE}
# Removing missing Values and unnecessary columns
clean_wage <- median_wage %>%
  select(-Code, -Name) %>%
  slice(-c(1, 2, 3, 4))

# Wide to Long format
clean_wage <- clean_wage %>%
  pivot_longer(
    cols = everything(),
    names_to = "month",
    values_to = "median_wage") %>%
  mutate(median_wage = readr::parse_number(median_wage))
```

```{r wage_quarter, include = FALSE}
# Convert wage median to quarterly median
wage_quarterly <- clean_wage %>%
  mutate(
    quarter = case_when(
      month %in% c("January", "February", "March") ~ "q1",
      month %in% c("April", "May", "June")         ~ "q2",
      month %in% c("July", "August", "September")  ~ "q3"))
wage_quarterly <- wage_quarterly %>%
  group_by(quarter) %>%
  summarise(
    median_wage_q = mean(median_wage, na.rm = TRUE),
    .groups = "drop")
```

```{r wage_log, include = FALSE}
# Add log median wage quarterly
wage_quarterly <- wage_quarterly %>%
  mutate(log_median_wage_q = log(median_wage_q))
```

```{r density_cleaning, include = FALSE}
# Clean Density data set
# Cleaning the Polish letters and NAs from Density data set
clean_density <- density %>%
  clean_names() %>%
  select(-code) %>%
  mutate(across(where(is.character),
                ~ tolower(stri_trans_general(., "Latin-ASCII"))))%>%

  # remove missing values
  na.omit()

# Erase first 2 rows and "Distric 8" from the name
clean_density <- clean_density %>%
  slice(-c(1, 2)) %>% # remove first 2 rows
  mutate(
    name = str_remove(name, "\\s*-\\s*district\\s*\\(8\\)"))
```

```{r data_merge, include = FALSE}
# Merging all datasets into one final dataset for analysis
final_data <- clean_prices %>%
  left_join(clean_density, by = c("dzielnica" = "name")) %>%
  left_join(wage_quarterly, by = c("quarter_only" = "quarter"))
```

```{r data_final_check, include = FALSE}
# Check final data for type of variables and transform where needed
str(final_data)
final_data <- final_data %>%
  mutate(
    population_per_1_km2 = as.numeric(population_per_1_km2))
```

```{r final_data, include = FALSE}
# Change the names of neighborhoods to original ones with polish letters
final_data <- final_data %>%
  mutate(
    dzielnica = case_when(
      dzielnica == "bemowo"          ~ "Bemowo",
      dzielnica == "bialoleka"       ~ "Białołęka",
      dzielnica == "bielany"         ~ "Bielany",
      dzielnica == "mokotow"         ~ "Mokotów",
      dzielnica == "ochota"          ~ "Ochota",
      dzielnica == "praga-polnoc"    ~ "Praga Północ",
      dzielnica == "praga-poludnie"  ~ "Praga Południe",
      dzielnica == "srodmiescie"     ~ "Śródmieście",
      dzielnica == "targowek"        ~ "Targówek",
      dzielnica == "ursus"           ~ "Ursus",
      dzielnica == "ursynow"         ~ "Ursynów",
      dzielnica == "wawer"           ~ "Wawer",
      dzielnica == "wesola"          ~ "Wesoła",
      dzielnica == "wilanow"         ~ "Wilanów",
      dzielnica == "wlochy"          ~ "Włochy",
      dzielnica == "wola"            ~ "Wola",
      dzielnica == "zoliborz"        ~ "Żoliborz",
      dzielnica == "rembertow"        ~ "Rembertów",
      TRUE ~ dzielnica))
```

## **Introduction and Hypothesis**

### Background and purpose of the project
Housing affordability has become a central issue in urban real estate markets, particularly in large metropolitan areas where population concentration, income disparities, and spatial heterogeneity interact to shape residential outcomes. In such contexts, affordability is not only determined by overall price levels but also by local factors such as neighborhood density, access to employment, urban structure, and characteristics of the housing stock. Understanding how these factors vary within a city is therefore crucial for assessing affordability conditions and identifying spatial patterns that may not be visible at an aggregate level. *Warsaw*, as the capital and largest city of Poland, provides a particularly relevant case for examining these dynamics. The city exhibits substantial variation across districts in terms of population density, housing prices, income levels, and building characteristics. In addition, the Vistula River divides Warsaw into two distinct urban areas with different historical development paths and socio-economic profiles. These features make Warsaw well suited for a neighborhood-level analysis of residential affordability.

The purpose of this project is to analyze the *affordability* of residential real estate in Warsaw using transaction-level price data, population density measures, and income information. Affordability is conceptualized as the relationship between housing prices per square meter and income, allowing for comparisons across neighborhoods and housing segments. By combining descriptive analysis, regression-based methods, and spatial visualization techniques, the project aims to identify systematic patterns in affordability within the city and to assess whether commonly discussed determinants, such as density, location relative to the river, and building age, are empirically supported.

### Hypotheses

The main objective of the analysis is to model and compare residential real estate affordability across Warsaw’s neighborhoods using data from recent housing transactions. Based on urban economic theory, the following hypotheses are formulated for testing:

- **Hypothesis 1 (H1):** Neighborhoods with higher population density exhibit lower residential prices per square meter than neighborhoods with lower density.
- **Hypothesis 2 (H2):** Affordability of residential real estate on the left bank of the Vistula River in Warsaw is lower than in neighborhoods located on the right bank.
- **Hypothesis 3 (H3):** Affordability of residential real estate differs systematically across building age groups in Warsaw.

All hypotheses will be evaluated using regression analysis and spatial visualization techniques to assess the relationships between housing prices, income levels, population density, river location, and building age at the neighborhood level.

---

## **Data Description**

### Data Overview

The analysis is based on a merged dataset combining transaction-level residential price data with district-level socio-economic indicators. The final dataset contains individual apartment transactions in Warsaw from the first and second quarter of 2025 and includes both numeric and categorical variables describing prices, location, and housing characteristics. In addition, district-level information on population density and quarterly income is linked to each transaction via the district identifier.

*Table 1* summarises key characteristics of the final analytical dataset, including the number of observations, variables, districts, time coverage, and geocoding completeness.

```{r data_overview_facts, include=FALSE}
# Dataset size
n_transactions <- nrow(final_data)
n_variables    <- ncol(final_data)
n_districts    <- n_distinct(final_data$dzielnica)
quarters       <- sort(unique(final_data$quarter_only))

# Share of transactions with geo coordinates
share_geo <- mean(!is.na(final_data$longitude)&!is.na(final_data$latitude))*100

#  Missing key variables
missing_key <- tibble::tibble(
  Variable = c("cena_wartosc_1m2", "population_per_1_km2", "median_wage_q", "longitude/latitude"),
  Missing = c(
    sum(is.na(final_data$cena_wartosc_1m2)),
    sum(is.na(final_data$population_per_1_km2)),
    sum(is.na(final_data$median_wage_q)),
    sum(is.na(final_data$longitude) | is.na(final_data$latitude))))

# Transactions per district
district_transaction <- final_data %>%
  group_by(dzielnica) %>%
  summarise(
    n_transactions = n(),
    median_price_sqm = median(cena_wartosc_1m2, na.rm = TRUE),
    avg_density = first(population_per_1_km2),
    .groups = "drop") %>%
  arrange(desc(n_transactions))
```

```{r table_setup, include=FALSE}
# Setup for tables so later on in report only need to call kable function
style_kable <- function(
  tbl,
  caption,
  align = NULL,
  header_bg = "#f2f2f2",
  bootstrap = c("striped", "condensed", "bordered"),
  col_widths = NULL,
  bold_first_col = TRUE) {
  n_cols <- ncol(tbl)

  # Default alignment: left for first col, right for others
  if (is.null(align)) {
    align <- c("l", rep("r", n_cols - 1))}

# Make table look nice
  out <- tbl %>%
    kable(
      format = "html",
      caption = caption,
      align = align,
      escape = FALSE) %>%
    kable_styling(
      full_width = FALSE,
      position = "center",
      bootstrap_options = bootstrap) %>%
    row_spec(0, bold = TRUE, background = header_bg, align = "c")

# Default widths for 2-column tables
if (is.null(col_widths) && n_cols == 2) {
  col_widths <- c("220px", "140px")}

# Apply widths to as many columns as provided in col_widths
  if (!is.null(col_widths)) {
    for (i in seq_len(min(length(col_widths), n_cols))) {
      out <- out %>% column_spec(i, width = col_widths[i])}}

# Make bold first column
  if (bold_first_col) {
    out <- out %>% column_spec(1, bold = TRUE)}
  out}
```

```{r data_overview_table, echo=FALSE}
dataset_facts <- tibble::tibble(
  Metric = c(
    "Transactions (rows)",
    "Variables (columns)",
    "Districts",
    "Quarters covered",
    "Transactions with coordinates"),
  Value = c(
    format(n_transactions, big.mark = " "),
    n_variables,
    n_districts,
    paste(quarters, collapse = ", "),
    paste0(round(share_geo, 1), "%")))

# Display dataset overview table
style_kable(
  dataset_facts,
  caption = "Table 1. Overview of the final analytical dataset")
```

### Data sources

**Residential transaction** data are obtained from the [System for Analysis and Monitoring of the Real Estate Market (AMRON)](https://amron.pl/). This dataset contains individual apartment transactions, including information on transaction prices, price per square meter, transaction date, and location.

**Population density** data are sourced from the [Main Statistical Office of Poland](https://bdl.stat.gov.pl/bdl/start) and are available at the district level. Density is measured as the number of residents per square kilometer.

**Median income** data consist of median wage information, also provided by the [Main Statistical Office of Poland](https://bdl.stat.gov.pl/bdl/start). Wage data are available on a monthly basis.

---


## **Data Preparation**

### Data Cleaning and Transformation
The data preparation process consisted of the following steps:

1. **Standardisation of variables**: text variables (e.g. district and street names) were standardised by converting them to lowercase and removing Polish diacritics to ensure consistency across datasets.
2. **Handling missing values**: observations with missing key information (e.g. prices, coordinates) were removed where required for the analysis and visualisation.
3. **Geocoding**: transaction addresses were geocoded to obtain latitude and longitude coordinates.
4. **Alignment of income data**: monthly median wage data were aggregated to a quarterly level to match the transaction date information.
4. **Variable construction**: several analytical variables were created, including:
   - logarithm of price per square meter,
   - logarithm of median quarterly wage,
   - housing affordability defined as the ratio of price per square meter to income.
5. **Building age groups**: buildings were classified into age groups:
$$ \text{Building age group} =
\begin{cases}
\text{Very old} & (<1960) \\
\text{Old} & (1960\text{–}2010) \\
\text{New} & (2010\text{–}2025)
\end{cases} $$


### Data merging

After cleaning and transforming each dataset separately, the price, population density, and wage datasets were merged into a single analytical dataset. Transaction-level price data were linked to district-level population density using the district identifier, while quarterly median wages were merged based on the transaction quarter. For data integration purposes, district names were initially standardized to a common format. After completing the merge, district names were converted back to their original Polish spelling to ensure consistency and readability in tables, figures, and maps used in the analysis.

---

## **Data Analysis**
The empirical analysis builds on the prepared dataset to explore patterns in residential real estate affordability in Warsaw. The analysis combines numerical summaries and visual representations to examine both the distribution and spatial variation of key variables. These exploratory insights provide context for understanding how prices, income levels, and urban structure differ across the city and how these differences shape affordability outcomes.

### Descriptive Statistics {.tabset}
The descriptive analysis presents the main characteristics of the data using formats tailored to the nature of each variable. Transaction-level price data allow for a detailed examination of distributional properties, while wage and population density data, observed at aggregated spatial levels, are better described through levels and spatial patterns. Together, these descriptive elements offer an initial empirical overview of affordability-related dynamics within Warsaw.

#### Transaction Price Data {-}
Residential prices per square meter represent the **central variable** of interest in the analysis and therefore receive a more detailed descriptive treatment. Summary statistics are used to illustrate typical price levels, variability, and the presence of extreme values, while graphical representations highlight the overall shape of the price distribution. This allows for an initial assessment of market heterogeneity and provides context for the district-level comparisons presented later in the analysis.

```{r summary_stats_prices, class.source="fold-hide"}
# First we calculate summary statistics for price per square meter
summary_stats <- final_data %>%
summarise(
avg_price_sqm = mean(cena_wartosc_1m2, na.rm = TRUE),
median_price_sqm = median(cena_wartosc_1m2, na.rm = TRUE),
sd_price_sqm = sd(cena_wartosc_1m2, na.rm = TRUE),
min_price_sqm = min(cena_wartosc_1m2, na.rm = TRUE),
max_price_sqm = max(cena_wartosc_1m2, na.rm = TRUE))

# Clean version for report
summary_stats_fmt <- summary_stats %>%
  mutate(
    avg_price_sqm = scales::number(avg_price_sqm, big.mark = " ", decimal.mark = ","),
    median_price_sqm = scales::number(median_price_sqm, big.mark = " ", decimal.mark = ","),
    sd_price_sqm = scales::number(sd_price_sqm, big.mark = " ", decimal.mark = ","),
    min_price_sqm = scales::number(min_price_sqm, big.mark = " ", decimal.mark = ","),
    max_price_sqm = scales::number(max_price_sqm, big.mark = " ", decimal.mark = ","))
```
The summary statistics describe residential transaction prices expressed in Polish zloty per square meter (PLN/m²) and provide an overview of typical price levels and dispersion in the Warsaw housing market. The **mean price** amounts to approximately **`r summary_stats_fmt$avg_price_sqm` PLN/m²**, while the median is slightly lower at **`r summary_stats_fmt$median_price_sqm` PLN/m²**, indicating that higher-priced observations increase the average relative to the typical transaction. The difference between the mean and median suggests a **right-skewed price distribution**, where a limited number of very high-priced dwellings—often associated with particularly attractive locations or specific market segments. The standard deviation of **`r summary_stats_fmt$sd_price_sqm` PLN/m²** points to substantial variability in prices across transactions.

The observed price range, spanning from **`r summary_stats_fmt$min_price_sqm` PLN/m²** to **`r summary_stats_fmt$max_price_sqm` PLN/m²**, highlights pronounced heterogeneity within the market, reflecting strong differences in location, neighborhood characteristics, and housing quality. Overall, these statistics indicate that the median price provides a more representative measure of typical affordability conditions, while the mean captures the influence of the upper tail of the price distribution.

```{r stats_prices_table, echo = FALSE}
# We format the summary statistics into a table with renamed columns
stats_prices_table <- summary_stats %>%
  rename(
    `Mean` = avg_price_sqm,
    `Median` = median_price_sqm,
    `Standard Deviation` = sd_price_sqm,
    `Min` = min_price_sqm,
    `Max` = max_price_sqm) %>%
  pivot_longer( #Transform table into long format
    cols = everything(),
    names_to = "Statistics",
    values_to = "Value") %>%
  mutate(Value = round(Value, 2)) # Round values to 2 decimal places


# Custom function to format numbers in European style
stats_prices_table <- stats_prices_table %>%
  mutate(
    Value = formatC(
      as.numeric(Value),
      format = "f",
      digits = 2,
      big.mark = " ",
      decimal.mark = ","))

# Display the table using kable function
style_kable(
  stats_prices_table,
  caption = "Summary Statistics for Price/m²")

```
##### **Distribution of Prices per Square Meter** {.unnumbered}

As shown in **Figure 1**, the distribution of residential prices per square meter in Warsaw is *right-skewed*, indicating the presence of a relatively small number of very high-priced observations. The mean price exceeds the median, which confirms the positive skewness of the distribution. Most observations are concentrated within one standard deviation around the mean, while a long right tail reflects "premium" properties with substantially higher prices per square meter. This suggests that average prices are influenced by high-end segments of the market, whereas the median better represents typical transaction values.

```{r distribution_prices, echo = FALSE, fig.align="center"}
# Extract summary statistics for plotting
avg_price_sqm <- mean(final_data$cena_wartosc_1m2, na.rm = TRUE)
median_price_sqm <- median(final_data$cena_wartosc_1m2, na.rm = TRUE)
sd_price_sqm <- sd(final_data$cena_wartosc_1m2, na.rm = TRUE)

ggplot(final_data, aes(x = cena_wartosc_1m2)) +
  geom_histogram(
    aes(y = after_stat(density)),
    bins = 40,
    fill = "#7c9ecb",
    color = "white",
    alpha = 0.85) +
  geom_density(
    color = "#fc8d59",
    linewidth = 1.2) +
  # Median
  geom_vline(
    xintercept = median_price_sqm,
    linetype = "solid",
    color = "#fee090",
    linewidth = 0.9 ) +
  # Mean
  geom_vline(
    xintercept = avg_price_sqm,
    linetype = "dashed",
    color = "#fee090",
    linewidth = 0.6) +
  # ±1 Standard Deviation
  geom_vline(
    xintercept = c(avg_price_sqm - sd_price_sqm,
                   avg_price_sqm + sd_price_sqm),
    linetype = "dotted",
    color = "#fee090",
    linewidth = 0.8) +
  # Labels and theme
  labs(
    title = "Figure 1. Distribution of Residential Prices per m²",
    subtitle = "Mean (dashed), Median (solid), and ±1 Standard Deviation (dotted)",
    x = "Price (PLN/m²)",
    y = "Relative Frequency") +
  theme_minimal()
```

##### **Distribution of Prices per Square Meter by District** {.unnumbered}

**Figure 2** reveals pronounced **spatial disparities** in residential prices per square meter across Warsaw’s districts. The highest median prices are concentrated in the **city center**, with *Śródmieście* clearly standing out as the most expensive district, reflecting its centrality, concentration of economic activity, and access to urban amenities. Beyond the city core, *Wilanów* emerges as a notable **high-price district** despite its more peripheral location. This suggests that **price levels are not driven by centrality alone**, but also by housing quality, recent development patterns, and neighborhood prestige, which are characteristic of Wilanów’s predominantly modern and high-standard residential stock. In contrast, *Mokotów*, while still relatively expensive, exhibits lower median prices than Wilanów, highlighting **heterogeneity** even among traditionally high-value districts.

Lower median prices are observed in outer districts such as *Wawer*, *Białołęka*, and *Ursus*, which are characterized by lower density, greater distance from the city center, and more suburban development patterns. Overall, the spatial distribution reflects a **core–periphery structure** with important local deviations, underscoring the role of both location and neighborhood-specific attributes in shaping residential property prices in Warsaw.

```{r distribution_by_district, include = FALSE}
price_map_district <- final_data %>%
  group_by(dzielnica) %>%
  summarise(
    median_price_sqm = median(cena_wartosc_1m2, na.rm = TRUE),
    .groups = "drop")
```

```{r map_poland, include = FALSE}
# visualization of median price per sqm by district in Warsaw
# Load shapefile for Warsaw districts
warsaw_shp <- st_read("data/shapefiles/warszawa-dzielnice.geojson",
                      quiet = TRUE)
```

```{r plot_price_map, warning = FALSE, class.source="fold-hide"}
# Merge price data with shapefile
price_map_data <- warsaw_shp %>%
  left_join(price_map_district, by = c("name" = "dzielnica"))

# Create label points for districts
label_points <- price_map_data %>%
  # Additional functions added to ensure points are within polygons
  sf::st_transform(2180) %>%  # Appropriate CRS for Poland
  sf::st_point_on_surface() %>%
  sf::st_transform(sf::st_crs(price_map_data)) %>%  # Back to original CRS
  dplyr::mutate(label = name) %>%
  dplyr::filter(label != "Warszawa") # Remove name of the city from labels

# Moving some labels for better visibility
offsets <- tibble::tribble(
  ~label,            ~dx,    ~dy,
  "Praga Północ",    0.00,  -0.01,
  "Śródmieście",  0.00,  -0.01)

# Turn sf points into numeric coordinates
label_xy <- label_points %>%
  sf::st_coordinates() %>%
  as.data.frame() %>%
  dplyr::bind_cols(label_points %>%
                     sf::st_drop_geometry() %>%
                     dplyr::select(label))

# Join offsets and apply them (default dx/dy = 0)
label_final <- label_xy %>%
  dplyr::left_join(offsets, by = "label") %>%
  dplyr::mutate(
    dx = dplyr::coalesce(dx, 0),
    dy = dplyr::coalesce(dy, 0),
    X = X + dx,
    Y = Y + dy)
```

```{r plot_price_map_visual, echo = FALSE, warning = FALSE, message = FALSE,fig.align="center"}
# Plot map of median price per sqm by district
ggplot(price_map_data) +
  geom_sf(aes(fill = median_price_sqm), color = "white", linewidth = 0.3) +
  geom_text( # Add labels to districts
    data = label_final,
    aes(label = label, x = X, y = Y),
    size = 2.5,
    color = "grey30") +
  scale_fill_distiller(
    palette = "RdYlBu",
    direction = -1,     # blue = low, red = high
    na.value = "grey90",
    name = "Price (PLN/m²)") +
  theme_minimal() +
  labs(title = "Figure 2. Median Price per sqm by District in Warsaw",
       subtitle = "Warsaw, 2025",
       fill = "Price (PLN/m²)") +
  theme(
    axis.title = element_blank(),
    axis.text = element_blank(),
    panel.grid = element_blank())
```

#### Income and Population Density Data {-}

*Population density* and *income* constitute the key socio-economic variables used to assess affordability differences across Warsaw. Variables are observed at the district (density) and quarter (income) levels and linked to individual transactions via the district and date identifiers.

*Population density* varies substantially across the city, reflecting Warsaw’s core–periphery structure. Central districts exhibit markedly higher densities, while outer districts are characterised by more dispersed, suburban development patterns. **Figure 3** highlights pronounced differences in population density across Warsaw’s districts. Central areas such as Śródmieście and adjacent districts exhibit the highest population concentration, while peripheral districts show substantially lower density levels. This variation reflects differences in urban form and land use intensity and provides a structural context for the affordability analysis conducted later in the report.

```{r density_plot_setup, warning = FALSE, class.source="fold-hide"}
# Data for the plot
density_district <- final_data %>%
  group_by(dzielnica) %>%
  summarise(
    population_density = first(population_per_1_km2),
    .groups = "drop") %>%
  arrange(desc(population_density))

# Difining central and peripheral districts for color coding
central_districts <- c(
  "Śródmieście", "Wola", "Ochota", "Żoliborz",
  "Mokotów", "Praga Północ", "Praga Południe")

# Add a label for central vs peripheral
density_plot_data <- district_transaction %>%
  mutate(
    centrality = ifelse(dzielnica %in% central_districts,
                        "Central districts",
                        "Peripheral districts"))

# Order districts by density
density_plot_data <- density_plot_data %>%
  arrange(avg_density) %>%
  mutate(dzielnica = factor(dzielnica, levels = dzielnica))
```

```{r density_plot, echo=FALSE, fig.align="center"}
# Plot population density by district
ggplot(density_plot_data,
       aes(x = dzielnica,
           y = avg_density,
           fill = centrality)) +
  geom_col(width = 0.7) +
  scale_fill_manual(
    values = c(
      "Central districts" = "#fc8d59",
      "Peripheral districts" = "#91bfdb")) +
  labs(
    title = "Figure 3. Population Density by District in Warsaw",
    x = NULL,
    y = "Population density (ppl/km²)",
    fill = "District location") +
  theme_minimal() +
  theme(
    legend.position = "top",
    axis.text.y = element_text(size = 9),
    axis.text.x = element_text(
      angle = 45,
      hjust = 1,
      vjust = 1,
      size = 9))
```

*Income* data, expressed as quarterly median wages, show relatively smaller variation across districts compared to prices, but still indicate meaningful spatial differences in purchasing power. These variables provide an important contextual background for the affordability analysis and are examined descriptively before being combined with price data in the hypothesis testing stage.

### Hypotheses {.tabset}

#### Hypothesis 1 {-}

Population density is often discussed as an important factor shaping housing affordability. From a theoretical perspective, higher density may be associated with more intensive land use and a larger housing supply, which could exert downward pressure on prices per square meter. At the same time, dense areas are frequently located in central or well-connected parts of the city, where demand is strong and prices tend to be higher. Based on this ambiguity, the following hypothesis is tested:

##### *H1: Neighborhoods with higher population density exhibit lower residential prices per square meter than neighborhoods with lower density.* {.unnumbered}

The corresponding null hypothesis states that population density does not lead to lower prices:

##### *H0: Neighborhoods with higher population density **do not** exhibit lower residential prices per square meter than neighborhoods with lower density.* {.unnumbered}

To evaluate this relationship, a log–log linear regression is estimated using district-level averages.

```{r h1_regression, warning = FALSE, class.source="fold-hide"}
# Linear regression of price per sqm on population density
h1_data <- final_data %>%
  group_by(dzielnica) %>%
  summarise(
    avg_price_sqm = mean(cena_wartosc_1m2, na.rm = TRUE),
    density = first(readr::parse_number(as.character(population_per_1_km2))),
    .groups = "drop") %>%
  mutate(
    log_avg_price_sqm = log(avg_price_sqm),
    log_density = log(density))
```

```{r h1_plot, echo=FALSE, fig.align="center", message=FALSE}
ggplot(h1_data, aes(x = log_density, y = log_avg_price_sqm)) +
  geom_point(
    color = "#7c9ecb",
    size = 3,
    alpha = 0.85) +
  geom_smooth(
    method = "lm",
    se = FALSE,
    color = "#fc8d59",
    linewidth = 1.2) +
  labs(
    title = "Figure 4. Relationship Between Population Density and Housing Prices",
    subtitle = "Log–log scale, district-level averages",
    x = "Population Density (ppl/km²; log)",
    y = "Average Price (PLN/km²; log)") +
  theme_minimal()
```
The model relates the logarithm of average residential prices per square meter to the logarithm of population density at the district level. Following formula is estimated:
$$
\log(\text{Price}_{i}) = \alpha + \beta \log(\text{Density}_{i}) + \varepsilon_{i}
$$

The scatter plot and the fitted regression line (**Figure 4**) indicate a positive relationship between population density and average residential prices per square meter at the district level. Districts with higher population density tend to exhibit higher, rather than lower, housing prices. This pattern suggests that in Warsaw, dense neighborhoods are often located in areas with strong demand, good accessibility, and a high concentration of urban amenities, which outweigh potential price-reducing effects of higher housing supply. As a result, the empirical evidence from the log–log regression **does not support Hypothesis H1**. Instead, the observed relationship is more consistent with the null hypothesis, indicating that higher population density is not associated with lower residential prices per square meter. At the same time, the dispersion of points around the regression line highlights substantial heterogeneity across districts, implying that population density alone cannot fully explain price differences and that other location-specific factors play an important role.

---

##### **Interactive Map: Density–Price Patterns by District** {.unnumbered}

The map presents residential districts of Warsaw classified according to the relationship between population density and average transaction prices. Districts are color-coded based on whether their density–price combination **supports** or **contradicts Hypothesis 1**.


>By clicking on a district, additional information is displayed, including average price per square meter, population density, the assigned density–price pattern,  and examples of the most and least expensive transactions. Individual apartment transactions are shown as point markers and can be toggled on or off using the layer control. The map can be zoomed and panned to explore spatial patterns at different scales.

```{r h1_map_setup, warning = FALSE, class.source="fold-hide"}
# District polygons setup
districts_sf <- st_read("data/shapefiles/warszawa-dzielnice.geojson", quiet = TRUE) %>%
  st_transform(4326) %>%
  rename(dzielnica = name) %>%
  mutate(dzielnica = as.character(dzielnica))

# Setting up disctrict statistics for the map including avg price and density
district_stats <- final_data %>%
  group_by(dzielnica) %>%
  summarise(
    avg_price_sqm = mean(cena_wartosc_1m2, na.rm = TRUE),
    density = first(population_per_1_km2),
    .groups = "drop") %>%
  mutate(
    avg_price_sqm = as.numeric(avg_price_sqm),
    density = as.numeric(density))

# Categories for the map
# Here we create z-scores for price and density to classify districts
district_stats <- district_stats %>%
  mutate(
    z_price   = as.numeric(scale(avg_price_sqm)),
    z_density = as.numeric(scale(density)),
    h1_pattern = case_when(
      z_density > 0 & z_price < 0 ~ "Supports H1: High density / Low price",
      z_density < 0 & z_price > 0 ~ "Supports H1: Low density / High price",
      z_density > 0 & z_price > 0 ~ "Contradicts H1: High density / High price",
      z_density < 0 & z_price < 0 ~ "Contradicts H1: Low density / Low price",
      TRUE ~ "n/a"))

# Merging district polygons with statistics
fmt_pln <- function(x) format(round(x), big.mark = " ", decimal.mark = ",")

# Create popup labels for the map
districts_map <- districts_sf %>%
  left_join(district_stats, by = "dzielnica") %>%
  mutate(
    popup = paste0(
      "<b>",
      ifelse(is.na(dzielnica), "Unknown district", dzielnica),
      "</b><br/>",
      "Avg price: ", fmt_pln(avg_price_sqm), " PLN/m²<br/>",
      "Density: ", fmt_pln(density), " ppl/km²<br/>",
      "<b>", h1_pattern, "</b>"))

# Add transaction points to the map
apartments_sf <- final_data %>%
  filter(!is.na(longitude), !is.na(latitude)) %>%
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326, remove = FALSE) %>%
  select(-any_of("dzielnica"))

apartments_sf <- st_join(
  apartments_sf,
  districts_sf %>% select(dzielnica),
  join = st_within,
  left = TRUE)
```

```{r h1_map, echo=FALSE, warning = FALSE, message = FALSE, fig.width=10, fig.height=7}
# Create the interactive map using leaflet
pal_cat <- leaflet::colorFactor(
  palette = c(
    "Supports H1: High density / Low price"     = "#4575B4",
    "Supports H1: Low density / High price"    = "#91BFDB",
    "Contradicts H1: Low density / Low price"  = "#FEE090",
    "Contradicts H1: High density / High price" = "#D73027" ),
  domain = districts_map$h1_pattern,
  na.color = "#cccccc")

leaflet() %>%
  addProviderTiles("CartoDB.Voyager") %>%
  addPolygons(
    data = districts_map,
    fillColor = ~pal_cat(h1_pattern),
    fillOpacity = 0.6,
    color = "white",
    weight = 1,
    popup = ~popup,
    group = "H1 pattern") %>%
  addCircleMarkers(
    data = apartments_sf,
    lng = ~longitude, lat = ~latitude,
    radius = 3,
    stroke = FALSE,
    fillOpacity = 0.30,
    popup = ~paste0(
      "<b>", ifelse(is.na(dzielnica), "Unknown district", dzielnica), "</b><br/>",
      "Price: ", fmt_pln(cena_wartosc_1m2), " PLN/m²"),
    group = "Transactions") %>%
  addLegend(
    position = "bottomright",
    pal = pal_cat,
    values = districts_map$h1_pattern,
    title = "Density–price pattern (H1)",
    opacity = 1) %>%
  addLayersControl(
    overlayGroups = c("H1 pattern", "Transactions"),
    options = layersControlOptions(collapsed = FALSE))
```

The interactive choropleth map provides a spatial perspective on the relationship between population density and housing prices in Warsaw, complementing the regression-based analysis presented earlier. By jointly visualizing district-level density–price patterns and individual transaction locations, the map highlights areas where empirical outcomes align with or contradict the theoretical expectation that higher density is associated with lower prices.

Districts classified as **supporting Hypothesis 1** exhibit either high density with relatively lower prices or low density with higher prices, consistent with affordability effects predicted by urban economic theory. In contrast, districts marked as **contradicting Hypothesis 1** reveal cases where high density coincides with high prices or low density with low prices, suggesting the presence of additional structural factors such as location attractiveness, infrastructure quality, or neighborhood reputation. Overall, the map illustrates that the density–price relationship is spatially heterogeneous, reinforcing the need to interpret aggregate statistical results in a geographic context.

#### Hypothesis 2 {-}
##### *Affordability of residential real estate on the left bank of the Vistula River in Warsaw is lower in comparison to right bank neighborhoods* {.unnumbered}

The Vistula River represents a major spatial divide within Warsaw. Historically, the left bank has concentrated economic activity, central business districts, and higher-income neighborhoods, while the right bank has been more residential and, in some cases, less developed. These differences may translate into systematic affordability gaps between the two sides of the river.

We test whether higher population density is associated with lower residential prices per square meter.

<br>

##### *Affordability Calculation* {.unnumbered}

Housing affordability is calculated as the natural logarithm of the ratio between residential price per square meter and median wage:

$$
A_i = \ln \left( \frac{P_i}{W_i} \right)
$$

where $A_i$ represents affordability in district i, $P_i$ is residential price per square meter, and $W_i$ is the median wage.


**Figure 5** presents the spatial classification of Warsaw districts according to their location relative to the Vistula River. The map divides districts into left-bank and right-bank areas, which serves as the basis for the comparative affordability analysis conducted in this study. The Vistula River represents a major geographical and socio-economic boundary within the city, historically associated with differences in urban development patterns, infrastructure quality, and housing market dynamics.


```{r h2_affordability, warning = FALSE, class.source="fold-hide"}
# Definition of left and right bank districts and construction of the affordability measure
left_bank <- c(
  "Bemowo", "Bielany", "Mokotów", "Ochota",
  "Śródmieście", "Ursynów", "Wola",
  "Żoliborz", "Włochy", "Ursus","Wilanów")
right_bank <- c(
  "Białołęka", "Praga Północ", "Praga Południe",
  "Targówek", "Rembertów", "Wawer", "Wesoła")

# Merge river bank info and calculate affordability
clean_prices_h2 <- final_data %>%
  mutate(
    river_bank = case_when(
      dzielnica %in% left_bank  ~ "Left bank",
      dzielnica %in% right_bank ~ "Right bank",
      TRUE ~ NA_character_),
  median_wage_q = as.numeric(median_wage_q),
  # Affordability log calculation
    # We define affordability in logarithmic terms to express housing prices relative to income levels, allowing for proportional comparisons and reducing the influence of extreme values.
    log_affordability = log_price_sqm - log(median_wage_q))

# Dataset used for t-test
clean_prices_h2_ttest <- clean_prices_h2 %>%
  filter(river_bank %in% c("Left bank", "Right bank")) %>%
  filter(!is.na(log_affordability)) %>%
  mutate(river_bank = factor(river_bank, levels = c("Left bank", "Right bank")))
```

```{r h2_map_setup, warning = FALSE, class.source="fold-hide"}
# Load shapefile for Warsaw districts
warsaw_shp <- st_read("data/shapefiles/warszawa-dzielnice.geojson",
                      quiet = TRUE) %>%
    st_transform(4326)

# Bank classification for districts
bank_map_data <- warsaw_shp %>%
  mutate(
    river_bank = ifelse(
      name %in% left_bank,
      "Left bank",
      "Right bank"))


# Add Vislula River line
if (!file.exists("vistula_sf.rds")) {
  bb <- sf::st_bbox(bank_map_data)
  vistula_sf <- osmdata::opq(bbox = c(bb["xmin"], bb["ymin"], bb["xmax"], bb["ymax"])) %>%
    osmdata::add_osm_feature(key = "waterway", value = "river") %>%
    osmdata::osmdata_sf() %>%
    `[[`("osm_lines") %>%
    sf::st_transform(4326)

# Filter for warsaw only and keep only main part of the river
  vistula_sf <- sf::st_intersection(vistula_sf, sf::st_geometry(bank_map_data))
  vistula_sf <- sf::st_collection_extract(vistula_sf, "LINESTRING")
  vistula_named <- vistula_sf %>%
    dplyr::filter(!is.na(name) & stringr::str_detect(name, stringr::regex("wisła|wisla|vistula", ignore_case = TRUE)))
  if (nrow(vistula_named) > 0) {
    vistula_sf <- vistula_named}
  vistula_sf <- sf::st_union(vistula_sf)

# Save for future use
  saveRDS(vistula_sf, "vistula_sf.rds")} else {
  vistula_sf <- readRDS("vistula_sf.rds")}
```

```{r h2_affordability_map, echo=FALSE, warning=FALSE, message=FALSE, fig.align="center"}
# Plot map of river banks
ggplot(bank_map_data) +
  geom_sf(aes(fill = river_bank), color = "white", linewidth = 0.3) +
  geom_sf(data = vistula_sf, color = "#1d58a6", linewidth = 1) +
  geom_text(
    data = label_final,
    aes(x = X, y = Y, label = label),
    size = 2.6,
    color = "grey20") +
  scale_fill_manual(
    values = c("Left bank" = "#7c9ecb", "Right bank" = "#fc8d59"),
    na.value = "grey90",
    name = NULL) +
  theme_minimal() +
  labs(
    title = "Figure 5. Vistula River bank classification",
    subtitle = "Left bank vs Right bank") +
  theme(
    axis.title = element_blank(),
    axis.text = element_blank(),
    panel.grid = element_blank(),
    legend.position = "bottom")
```

The visual distribution shows that most central and highly developed districts are located on the left bank, while a larger share of peripheral and historically less urbanized districts is situated on the right bank. These structural differences suggest that housing market characteristics, including price levels and affordability conditions, may vary systematically between the two areas. Consequently, the classification illustrated in **Figure 5** provides the spatial framework for testing whether residential affordability differs between river banks.

---

#####  *T-test Affordability* {.unnumbered}

The t-test analysis evaluates whether residential housing affordability differs between the left and right banks of the Vistula River. Affordability is measured as the logarithmic ratio between price per square meter and median wage, allowing comparisons across districts with different income levels.

The results indicate a clear and statistically significant difference in affordability between the two river banks. The average log-affordability on the left bank amounts to approximately **0.510**, whereas the right bank exhibits a lower mean value of approximately **0.387**. Since higher log-affordability values correspond to higher housing costs relative to income, these results suggest that residential properties located on the left bank are generally less affordable than those on the right bank.

The statistical evidence supporting this difference is strong. The t-statistic of **9.49** and the extremely small p-value **(p < 0.001)** indicate that the observed affordability gap is highly unlikely to be driven by random variation. Furthermore, the one-sided confidence interval confirms that affordability on the left bank is consistently higher than on the right bank across the sampled districts.


```{r h2_t-test_table, warning = FALSE, class.source="fold-hide", fig.align="center"}

tt <- t.test(log_affordability ~ river_bank,
             data = clean_prices_h2_ttest,
             alternative = "greater")

tt_tbl <- tibble::tibble(
  Metric = c("t statistic", "df", "p-value", "95% CI (lower)", "95% CI (upper)",
             "Mean (Left bank)", "Mean (Right bank)"),
  Value = c(
    unname(tt$statistic),
    unname(tt$parameter),
    tt$p.value,
    tt$conf.int[1],
    tt$conf.int[2],
    unname(tt$estimate[1]),
    unname(tt$estimate[2]))) %>%
  mutate(
    Value = if_else(
      Metric == "p-value",
      format(Value, scientific = TRUE, digits = 3),
      format(round(as.numeric(Value), 4), nsmall = 4))) %>%
rename(Statistics = Metric)
style_kable(
  tt_tbl,
  caption = "One-sided t-test results: log-affordability by Vistula River bank",
  align = c("l", "r"))
```
<br>

Overall, the empirical results provide strong evidence that housing affordability varies systematically across the Vistula River banks. The analysis therefore supports Hypothesis 2, indicating that residential real estate located on the left bank is significantly less affordable relative to income compared to the right bank.

---

##### *Boxplot of Affordability by River Bank* {.unnumbered}

The **Figure 6** illustrates the distribution of log-affordability across the left and right banks of the Vistula River. The results indicate that the median log-affordability is higher on the left bank, suggesting that residential properties are generally less affordable relative to income compared to the right bank. In addition, the interquartile range is slightly wider for the left bank, indicating greater variability in affordability outcomes within this area. While both distributions exhibit some dispersion and overlap, the overall upward shift of the left-bank distribution suggests systematically higher price-to-income ratios. These visual findings are consistent with the statistical results of the one-sided t-test, which confirmed a significant difference in mean affordability between the two river banks.

<br>

```{r h2_boxplot_single, warning = FALSE, class.source="fold-hide", fig.align="center"}
ggplot(clean_prices_h2, aes(x = river_bank, y = log_affordability, fill = river_bank)) +
    geom_boxplot(
        width = 0.40,
        alpha = 0.65,
        outlier.shape = NA,
        color = "black") +
    scale_fill_manual(
        values = c(
        "Left bank"  = "#7c9ecb",
        "Right bank" = "#fc8d59"
        )) +
    labs(
        title = "Figure 6. Log-affordability by Vistula River bank",
        x = NULL,
        y = "Log affordability (PLN/m² / income)"
    ) +
    theme_minimal() +
    theme(
        legend.position = "none",
        plot.title = element_text(size = 14),
        panel.grid.minor = element_blank()
    )
```



##### Boxplot with Jittered Individual Observations {.unnumbered}

**Decide on which boxplot version (fig 6 or fig 6.1)**


```{r h2_boxplot_Jittered, warning = FALSE, class.source="fold-hide", fig.align="center"}

# Data preparation for boxplot
plot_data <- clean_prices_h2 %>%
  filter(!is.na(river_bank), !is.na(log_affordability)) %>%
  mutate(
    river_bank = factor(
      river_bank,
      levels = c("Left bank", "Right bank")))

# Summary statistics for mean and 95% CI
ggplot(plot_data, aes(x = river_bank, y = log_affordability, fill = river_bank)) +
  geom_boxplot(
    width = 0.40,
    alpha = 0.65,
    outlier.shape = NA) +
  geom_jitter(
    aes(color = river_bank),
    width = 0.15,
    alpha = 0.25,
    size = 0.8) +
  stat_summary(
    fun = mean,
    geom = "point",
    size = 2.8,
    color = "black") +
  scale_fill_manual(
    values = c("Left bank" = "#7c9ecb", "Right bank" = "#fc8d59")) +
  scale_color_manual(
    values = c("Left bank" = "#7c9ecb", "Right bank" = "#fc8d59")) +
  labs(
    title = "Figure 6.1. Log-affordability by Vistula River bank",
    x = NULL,
    y = "Log affordability (PLN/m² / income)") +
  theme_minimal() +
  theme(
    legend.position = "none",
    plot.title = element_text(),
    panel.grid.minor = element_blank())
```

---

##### *Mean + 95% CI plot* {.unnumbered}


The **Figure 7** presents the mean log affordability index across the left and right banks of the Vistula River, together with 95% confidence intervals. The results indicate that average affordability differs systematically between the two river banks. The mean log affordability is higher on the left bank, indicating that residential prices relative to income are higher in these districts and, therefore, housing is less affordable compared to the right bank.

The confidence intervals around the group means do not overlap, providing visual evidence that the observed difference is statistically meaningful. This pattern is consistent with the results of the one-sided two-sample t-test, which confirms that the difference in affordability between the two river banks is statistically significant.

<br>

```{r Figure 7, warning = FALSE, class.source="fold-hide", fig.align="center"}

affordability_summary <- clean_prices_h2 %>%
  filter(!is.na(river_bank), !is.na(log_affordability)) %>%
  group_by(river_bank) %>%
  summarise(
    mean_affordability = mean(log_affordability),
    sd = sd(log_affordability),
    n = n(),
    se = sd / sqrt(n),
    ci_lower = mean_affordability - qt(0.975, df = n - 1) * se,
    ci_upper = mean_affordability + qt(0.975, df = n - 1) * se
  )

ggplot(affordability_summary,
       aes(x = river_bank, y = mean_affordability)) +

  geom_errorbar(
    aes(ymin = ci_lower, ymax = ci_upper),
    width = 0.12,
    linewidth = 1.2,
    colour = "black"
  ) +

  geom_point(
    aes(fill = river_bank),
    shape = 21,
    size = 4,
    colour = "black",
    stroke = 1.1
  ) +

  scale_fill_manual(values = c(
    "Left bank" = "#7c9ecb",
    "Right bank" = "#fc8d59"
  )) +

  labs(
    title = "Figure 7. Mean + 95% CI of log-affordability by Vistula River bank",
    x = NULL,
    y = "Mean log affordability (PLN/m² / income)"
  ) +

  theme_minimal() +
  theme(
    legend.position = "none",
    plot.title = element_text(size = 14),
    panel.grid.minor = element_blank()
  )
```

---

##### Boxplot + Mean CI Plot {.unnumbered}

To provide a comprehensive visual summary of residential affordability differences across the Vistula River banks, we combine the boxplot representation with the mean and 95% confidence interval visualization in a single figure **(Figure 8)**. This integrated approach builds upon the previous analyses, where the boxplot was used to illustrate the distributional characteristics of log-affordability, while the Mean + 95% CI plot highlighted differences in central tendency and statistical uncertainty between the two river banks.

Consistent with the previous observations, the combined figure confirms that residential real estate on the left bank exhibits higher average log-affordability values compared to the right bank, implying relatively lower affordability when housing prices are evaluated against income levels. The boxplot component reveals that the overall distribution on the left bank is shifted upward, with a slightly higher median and a comparable dispersion relative to the right bank. The inclusion of individual data points further illustrates the heterogeneity in affordability outcomes across districts.


```{r Figure 8, warning = FALSE, class.source="fold-hide", fig.align="center"}

# Prepare summary data for CI


affordability_summary <- clean_prices_h2 %>%
filter(!is.na(river_bank), !is.na(log_affordability)) %>%
group_by(river_bank) %>%
summarise(
mean_affordability = mean(log_affordability),
sd = sd(log_affordability),
n = n(),
se = sd / sqrt(n),
ci_lower = mean_affordability - qt(0.975, df = n - 1) * se,
ci_upper = mean_affordability + qt(0.975, df = n - 1) * se
)


# Combined Plot


ggplot(clean_prices_h2, aes(x = river_bank, y = log_affordability, fill = river_bank)) +

# Boxplot
geom_boxplot(
width = 0.40,
alpha = 0.65,
outlier.shape = NA,
color = "black"
) +

# Individual observations
geom_jitter(
aes(color = river_bank),
width = 0.15,
alpha = 0.25,
size = 0.8
) +

# 95% CI error bars
geom_errorbar(
data = affordability_summary,
aes(
x = river_bank,
ymin = ci_lower,
ymax = ci_upper
),
width = 0.08,
color = "black",
size = 1.2,
inherit.aes = FALSE
) +

# Mean points
geom_point(
data = affordability_summary,
aes(x = river_bank, y = mean_affordability),
color = "black",
size = 3,
inherit.aes = FALSE
) +

# Colours (your palette)
scale_fill_manual(values = c(
"Left bank" = "#7c9ecb",
"Right bank" = "#fc8d59"
)) +

scale_color_manual(values = c(
"Left bank" = "#7c9ecb",
"Right bank" = "#fc8d59"
)) +

# Labels
labs(
title = "Figure 8. Log-affordability by Vistula River bank",
x = "River bank",
y = "Log affordability ln(Price per m² / Median income)"
) +

# Styling
theme_minimal() +
theme(
legend.position = "none",
plot.title = element_text(size = 14),
panel.grid.minor = element_blank()
)
```


The superimposed mean markers and confidence interval bars provide an inferential perspective that complements the descriptive distributional analysis. The confidence intervals around the group means remain clearly separated, reinforcing the statistical significance identified in the t-test results presented earlier. This visual consistency across multiple representations strengthens the robustness of the findings and confirms that the observed affordability differences between river banks are not driven by outliers or distributional anomalies.

Overall, the combined visualization offers a consolidated interpretation by simultaneously presenting distributional shape, central tendency, and statistical inference, thereby providing a more complete and intuitive understanding of spatial affordability disparities in Warsaw’s housing market.

---
#### Hypothesis 3 {-}
##### *Affordability of residential real estate differs systematically across building age groups in Warsaw* {.unnumbered}

Newer residential buildings are typically associated with higher construction standards, modern amenities, and stronger market demand, potentially leading to higher prices relative to income. For this analysis, buildings are grouped by construction period into **very old (pre-1960)**, **old (1960–2010)**, and **new (2010–2025)** categories. The hypothesis examines whether residential affordability differs systematically across these building age groups.
<br>
<br>

##### *ANOVA + Tukey Test* {.unnumbered}

A one-way analysis of variance (ANOVA) is applied to test whether mean log-affordability differs across the defined building age groups. The null hypothesis states that mean affordability is equal across all groups, while the alternative hypothesis posits that at least one group exhibits a different mean log-affordability.
Since the ANOVA test only indicates whether a difference exists but does not identify which groups differ, a Tukey Honestly Significant Difference (HSD) post-hoc test is subsequently conducted. The Tukey test performs pairwise comparisons between groups while controlling for multiple testing, allowing for the identification of statistically significant differences in mean log-affordability across building age categories.

**Null hypothesis (H₀):**
Mean log-affordability is equal across all building age groups.

**Alternative hypothesis (H₁):**
At least one building age group exhibits a different mean log-affordability.

```{r h3_anova_table, warning = FALSE, class.source="fold-hide", fig.align="center"}
# Data preparation for ANOVA and Tukey tests
# Exclude missing building age
clean_prices_h3 <- clean_prices_h2 %>%
  dplyr::filter(!is.na(building_age_group), !is.na(log_affordability))

# ANOVA test for H3
anova_h3 <- aov(log_affordability ~ building_age_group, data = clean_prices_h3)

# Extract only the row for the factor (not residuals)
anova_row <- broom::tidy(anova_h3) %>%
  filter(term == "building_age_group") %>%
  slice(1)

anova_tbl_df <- tibble(
  Statistics = c("Df (between groups)", "Df (residuals)", "F statistic", "p-value"),
  Value = c(
    anova_row$df,
    anova_h3$df.residual,
    anova_row$statistic,
    anova_row$p.value
  )
) %>%
  mutate(
    Value = ifelse(
      Statistics == "p-value",
      format(as.numeric(Value), scientific = TRUE, digits = 3),
      round(as.numeric(Value), 4)
    )
  )

# Visual setup for ANOVA table
anova_table <- style_kable(
  anova_tbl_df,
  caption = "ANOVA results: log-affordability by building age group",
  align = c("l", "r"),
  bootstrap = c("striped", "condensed", "bordered"))
```


```{r h3_tukey_table, warning = FALSE, results="asis", class.source="fold-hide", fig.align="center"}

# Tukey for H3
tukey_h3 <- TukeyHSD(anova_h3)

tukey_df <- broom::tidy(tukey_h3) %>%
  filter(term == "building_age_group") %>%
  transmute(
    Comparison = contrast,
    `Mean diff` = round(estimate, 4),
    `CI lower`  = round(conf.low, 4),
    `CI upper`  = round(conf.high, 4),
    `p adj`     = format(adj.p.value, scientific = TRUE, digits = 3)
  )

# Change names of classifications
# Visual setup for Tukey table
tukey_table <- style_kable(
  tukey_df,
  caption = "Tukey HSD pairwise comparisons",
  align = c("l", "r", "r", "r", "r"),
  col_widths = c("130px", "100px", "100px", "100px", "100px"))


# Side-by-side layout for tables
cat(
  '<div style="display:flex; gap:40px; align-items:flex-start;">',
  '<div style="flex:1;">', as.character(anova_table), '</div>',
  '<div style="flex:1;">', as.character(tukey_table), '</div>',
  '</div>'
)
```




The **ANOVA** results indicate a statistically significant difference in mean log-affordability across the groups **(p < 0.001)**. The **Post-hoc Tukey HSD** comparisons show that newer buildings exhibit significantly higher log-affordability than older buildings, indicating lower affordability for newer housing stock. However, the difference in mean log-affordability between newer and very old buildings is not statistically significant. In addition, very old buildings display significantly higher log-affordability compared to old buildings. Overall, these results suggest that affordability varies non-monotonically across groups, with newer and very old buildings being less affordable relative to older housing stock.


___


##### *Boxplot of affordability by building age group* {.unnumbered}

The **Figure 9** illustrates the distribution of log-affordability across the three defined building age groups. Consistent with the statistical results presented in the ANOVA and Tukey post-hoc tests, noticeable differences in affordability levels are observable across categories. **New buildings (2010–2025)** display the highest median log-affordability values, indicating lower affordability relative to income. **Very old buildings (pre-1960)** exhibit similarly elevated affordability ratios, although with greater dispersion and a higher presence of extreme observations. In contrast, **buildings constructed between 1960 and 2010** show the lowest median log-affordability levels, suggesting comparatively higher affordability.



```{r h3_boxplot, warning = FALSE, results="asis", class.source="fold-hide", fig.align="center"}

# Data preparation for boxplot
clean_prices_h3 <- clean_prices_h3 %>%
  mutate(
    building_age_group = factor(
      building_age_group,
      levels = c("very_old", "old", "new"),
      labels = c("Very old (pre-1960)", "Old (1960–2010)", "New (2010–2025)")))

# Define colors for building age groups
h3_cols <- c(
  "Very old (pre-1960)" = "#4575b4",
  "Old (1960–2010)"     = "#ffffbf",
  "New (2010–2025)"     = "#fc8d59")

# Boxplot with jittered points
p_h3_box_jitter <- ggplot(
  clean_prices_h3,
  aes(x = building_age_group, y = log_affordability, fill = building_age_group)) +
  geom_boxplot(width = 0.40, alpha = 0.65, outlier.shape = NA) +
  geom_jitter(
    aes(color = building_age_group),
    width = 0.15,
    alpha = 0.20,
    size = 0.8
  ) +
  stat_summary(fun = mean, geom = "point", size = 2.6, color = "black") +
  scale_fill_manual(values = h3_cols) +
  scale_color_manual(values = h3_cols) +
  labs(
    title = "Figure 9. Log-affordability by building age group",
    x = NULL,
    y = "Log affordability (PLN/m² / income)") +
  theme_minimal() +
  theme(
    legend.position = "none",
    plot.title = element_text(),
    panel.grid.minor = element_blank())

p_h3_box_jitter
```


The interquartile ranges further highlight variation across categories. New buildings demonstrate relatively wide distributions, reflecting heterogeneity within the modern housing stock, potentially driven by differences in location, quality, and development standards. **Very old buildings** also exhibit substantial dispersion, which may reflect varying renovation status, structural condition, and neighborhood characteristics. The narrower distribution observed for the **1960–2010 category** suggests more homogeneous affordability outcomes for this segment of the housing stock.

Overall, the visual patterns support the ANOVA findings that affordability differs significantly across building age groups. In particular, the boxplot confirms the Tukey HSD results indicating statistically significant differences between old and new buildings, as well as between very old and old buildings, while differences between very old and new buildings appear less pronounced. These findings reinforce the conclusion that affordability follows a non-linear pattern across construction periods, with mid-age housing displaying relatively higher affordability compared to both newer and very old residential stock.

---



##### *Ridgeline plot* {.unnumbered}

The ridgeline plot **(Figure 10)** offers an alternative visualization of the distribution of log-affordability across building age groups, complementing the boxplot and statistical test results. By illustrating smoothed density curves, the figure provides insight into how affordability values are distributed within each construction period.



```{r h3_ridgeline, warning=FALSE, message=FALSE, class.source="fold-hide", fig.align="center"}

ggplot(clean_prices_h3, aes(x = log_affordability,
                            y = building_age_group,
                            fill = after_stat(x))) +
  geom_density_ridges_gradient(
    alpha = 0.95,
    scale = 1.2,
    rel_min_height = 0.01,
    color = "#91bfdb",
    linewidth = 0.3) +
scale_fill_gradientn(
  colours = c("#4575B4", "#FFFFBF", "#D73027"),
    values  = c(0, 0.5, 1),
    name = "Log affordability") +
  labs(
    title = "Figure 10. Distribution of log-affordability by building age group",
    x = "Log affordability (PLN/m² / income)",
    y = NULL) +
  theme_minimal() +
  theme(
    legend.position = "right",
    panel.grid.minor = element_blank())
```

Consistent with previous findings, **new buildings (2010–2025)** show a distribution shifted toward higher log-affordability values, indicating lower affordability relative to income. **Very old buildings (pre-1960)** display a similarly elevated but more dispersed distribution, suggesting greater heterogeneity in affordability outcomes. In contrast, buildings constructed **between 1960 and 2010** present a more concentrated distribution around lower log-affordability values, indicating relatively higher affordability.

Overall, the ridgeline plot confirms the non-monotonic affordability pattern identified in the ANOVA and Tukey HSD tests, reinforcing that mid-age housing stock tends to be more affordable than both newer and very old buildings.



## **Discussion**

The empirical analysis shows that residential affordability in Warsaw varies across spatial location, urban structure, and housing characteristics. The combined statistical tests and visual analyses highlight systematic differences across neighbourhoods and housing segments.

For Hypothesis 1, the results provide only partial support. While population density differs substantially across districts, higher density is often associated with higher prices rather than lower ones. This suggests that density reflects demand concentration, accessibility, and amenity availability rather than acting as an independent driver of affordability.

The findings for Hypothesis 2 indicate clear affordability differences between the two sides of the Vistula River. The left bank displays significantly higher log-affordability values, indicating lower affordability relative to income. These results likely reflect historical development patterns, infrastructure concentration, and economic activity clustering.

The results strongly support Hypothesis 3, showing that affordability differs across building age groups. New buildings tend to be less affordable relative to income, while buildings constructed between 1960 and 2010 appear comparatively more affordable. Very old buildings display greater variation in affordability outcomes, reflecting differences in renovation status and property quality.

It is also important to acknowledge that transaction volumes differ across districts. Central districts account for a larger share of observed transactions, while peripheral districts show lower market activity. This uneven distribution may influence affordability comparisons, as districts with fewer transactions may be less representative of local housing conditions.


---
## **Limitations**

The study is subject to several limitations. First, the analysis covers only two quarters of transaction data, capturing short-term market conditions rather than long-term trends.

Second, affordability is measured using a price-to-income ratio, which does not include financing conditions, household wealth, or supply constraints, and therefore provides a simplified affordability proxy.

Third, socio-economic variables are measured at the district level, which may mask variation within districts and introduce aggregation bias.

Finally, building age categories are broad and do not incorporate renovation status or building quality. In addition, the analysis identifies statistical relationships but does not establish causal effects.


## **Conclusion**

This study examined residential real estate affordability in Warsaw by analysing transaction-level housing price data combined with socio-economic indicators. The analysis focused on identifying spatial and structural differences in affordability across neighbourhoods, river location, and building age groups.

The results show that affordability varies systematically across the city. Population density alone does not lead to lower housing prices, suggesting that dense areas often reflect higher demand and accessibility advantages. Clear spatial differences were observed between the two sides of the Vistula River, with left-bank districts displaying lower affordability relative to income. In addition, housing affordability differs across building age groups, with newer buildings tending to be less affordable and mid-age housing stock appearing comparatively more accessible.

These findings highlight the importance of considering urban structure, historical development patterns, and housing characteristics when analysing affordability conditions. The results also illustrate the value of combining statistical modelling with spatial and distributional visualisations to capture heterogeneity within urban housing markets.

Future research could extend the analysis by incorporating longer time horizons, additional housing quality indicators, and financing conditions in order to provide a more comprehensive understanding of affordability dynamics in Warsaw.